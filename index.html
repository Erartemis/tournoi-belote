<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tournoi mondial de coinche Ã  Vancouver</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --accent:#2b7a78; --qualif:#cce8ff; }
    body { font-family:'Segoe UI',Roboto,Arial,sans-serif; background:#f4f6f8; margin:20px; color:#222; }
    header { text-align:center; margin-bottom:18px; }
    h1 { margin:0; font-size:1.8rem; color:var(--accent); }
    h2 { margin:24px 0 12px; color:#333; text-align:center; }
    /* Poules */
    .poules,.matches { display:flex; flex-wrap:wrap; gap:18px; justify-content:center; }
    .poule-card,.match-poule-card {
      background:#fff; border-radius:10px; padding:14px; width:320px;
      box-shadow:0 6px 16px rgba(20,20,30,0.06);
    }
    .poule-title,.match-poule-title {
      font-weight:700; font-size:1.05rem; color:#222; text-align:center; margin-bottom:8px;
    }
    .team-header {
      display:grid; grid-template-columns:1fr 100px 60px;
      gap:8px; align-items:center; padding:6px 10px;
      font-size:.8rem; color:#888; font-weight:500;
      border-bottom:1px solid #eee; margin-bottom:4px;
    }
    .team {
      display:grid; grid-template-columns:1fr 100px 60px;
      gap:8px; align-items:center; padding:10px; margin:6px 0;
      border-radius:8px; cursor:pointer;
      transition:background .16s, transform .12s;
    }
    .team:hover { background:#eef9ff; transform:translateY(-2px); }
    .team .name { font-weight:600; color:#153243; overflow:hidden; text-overflow:ellipsis; }
    .team .ratio { text-align:center; font-weight:700; }
    .team .score { text-align:right; font-weight:700; color:#0b3b2e; }
    .victory{color:green;} .defeat{color:red;} .qualified{background:var(--qualif);}
    /* Matchs de poules */
    .match-container {
      border:1px solid #eee; border-radius:6px; background:#fff;
      display:grid; grid-template-rows:1fr 1fr; margin-bottom:12px; position:relative;
    }
    .match-team-row {
      display:grid; grid-template-columns:1fr 100px; align-items:center; padding:8px 12px;
    }
    .match-team-scores { display:flex; gap:4px; justify-content:end; color:var(--accent); }
    .winning-score{font-weight:bold;}
    .match-unplayed {
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      color:#ff8c00; font-style:italic; font-weight:bold; font-size:.9rem;
    }
    /* Tableau final */
    .table-wrapper{max-width:1200px;margin:0 auto;}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;box-shadow:0 6px 14px rgba(10,10,20,.04);}
    th,td{padding:10px 12px;border-bottom:1px solid #eee;text-align:center;font-size:.95rem;}
    th{background:var(--accent);color:#fff;font-weight:700;} tr:hover td{background:#fafafa;}
    .winner{background:#dfffe0!important;font-weight:700;}
    /* Modal */
    .modal{
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:999;
    }
    .modal .card{
      background:#fff; padding:18px; border-radius:8px; width:320px;
      box-shadow:0 8px 30px rgba(0,0,0,.2); text-align:center;
    }
    .modal .close{float:right;cursor:pointer;color:#888;font-size:20px;font-weight:700;}
  </style>
</head>
<body>
  <header><h1>Tournoi mondial de coinche Ã  Vancouver</h1></header>
  <h2>Poules</h2><div id="poules-container" class="poules"></div>
  <h2>Matchs de poules</h2><div id="matches-container" class="matches"></div>
  <div id="tableFinalSection" style="display:none;">
    <h2>Tableau Final</h2>
    <div class="table-wrapper">
      <table id="tableauFinal">
        <thead><tr><th>Phase</th><th>Match</th><th>Ã‰quipe A</th><th>Ã‰quipe B</th><th>Score A</th><th>Score B</th><th>Vainqueur</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="playerModal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <div class="close" id="modalClose">&times;</div>
      <h3 id="modalTeamName"></h3>
      <p id="modalPlayers" style="margin-top:10px;color:#333;font-weight:600;"></p>
    </div>
  </div>

  <script>
    const urls = {
      equipes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiuPsbbwqM3BRrL4zmmQFl1fGkyLi2j4tPBasqAhZVYYWccSzpMhos5CDIqXeUZR0pJai6S5nLJw1K/pub?gid=1860524493&single=true&output=csv",
      tableau: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiuPsbbwqM3BRrL4zmmQFl1fGkyLi2j4tPBasqAhZVYYWccSzpMhos5CDIqXeUZR0pJai6S5nLJw1K/pub?gid=760310331&single=true&output=csv",
      matchs:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiuPsbbwqM3BRrL4zmmQFl1fGkyLi2j4tPBasqAhZVYYWccSzpMhos5CDIqXeUZR0pJai6S5nLJw1K/pub?gid=285227174&single=true&output=csv"
    };

    const toInt = v => parseInt((v||'').toString().replace(/\D+/g,''))||0;

    // --- POULES ---
    function afficherPoules(data) {
      const cont = document.getElementById('poules-container');
      cont.innerHTML = "";
      const poules = {};

      data.forEach(r => {
        const p = r.Poule?.trim();
        if (!p) return;
        (poules[p] ??= []).push(r);
      });

      // Tri
      Object.values(poules).forEach(p =>
        p.sort((a,b)=>{
          const [va,vb] = [toInt(a.Victoires), toInt(b.Victoires)];
          const [da,db] = [toInt(a.Defaites), toInt(b.Defaites)];
          const [sa,sb] = [toInt(a["Score total"]), toInt(b["Score total"])];
          if(va!==vb) return vb-va;
          if(da!==db) return da-db;
          return sb-sa;
        })
      );

      // Top 2 meilleurs troisiÃ¨mes
      const meilleurs3 = Object.values(poules).map(p=>p[2]).filter(Boolean)
        .sort((a,b)=>toInt(b["Score total"])-toInt(a["Score total"]))
        .slice(0,2);

      Object.keys(poules).sort().forEach(p=>{
        const card = document.createElement('div');
        card.className = 'poule-card';
        card.innerHTML = `<div class="poule-title">Poule ${p}</div>
          <div class="team-header"><div>Ã‰quipe</div><div>Victoires/DÃ©faites</div><div>Score</div></div>`;
        poules[p].forEach((t,i)=>{
          const name = t["Nom de lâ€™Ã©quipe"] || t["Nom equipe"] || t["Nom"] || "";
          const vic = t.Victoires||0, def = t.Defaites||0, score=t["Score total"]||0;
          const div=document.createElement('div');
          div.className='team';
          if(i<2||meilleurs3.includes(t)) div.classList.add('qualified');
          const medal=["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i]||((i===poules[p].length-1&&def>0)?"ðŸ’€":"");
          div.innerHTML=`<div class="name">${medal} ${name}</div>
            <div class="ratio"><span class="victory">${vic}</span>/<span class="defeat">${def}</span></div>
            <div class="score">${score}</div>`;
          div.onclick=()=>{
            document.getElementById('modalTeamName').textContent=name;
            document.getElementById('modalPlayers').textContent=[t["Joueur 1"],t["Joueur 2"]].filter(Boolean).join(' & ');
            document.getElementById('playerModal').style.display='flex';
          };
          card.appendChild(div);
        });
        cont.appendChild(card);
      });
    }

    // --- MATCHS DE POULES ---
    function afficherMatchesPoules(data){
      const cont=document.getElementById('matches-container');
      cont.innerHTML="";
      const parPoule={};
      data.forEach(m=> (parPoule[m.Poule||"Inconnue"] ??= []).push(m));

      for(const [poule, matchs] of Object.entries(parPoule)){
        const card=document.createElement('div');
        card.className='match-poule-card';
        card.innerHTML=`<div class="match-poule-title">Poule ${poule}</div>`;

        matchs.forEach(m=>{
          const teamA=m["Ã‰quipe A"]||m["Equipe A"]||"?", teamB=m["Ã‰quipe B"]||m["Equipe B"]||"?";
          const scoresA=[1,2,3].map(i=>toInt(m[`Partie ${i}-score A`])),
                scoresB=[1,2,3].map(i=>toInt(m[`Partie ${i}-score B`]));
          const unplayed=scoresA.every(s=>s===0)&&scoresB.every(s=>s===0);
          const row=(n,name,sA,sB)=>`<div class="match-team-row">
            <div class="match-team-name${n===1&&m.Vainqueur===teamA||n===2&&m.Vainqueur===teamB?' fw-bold':''}">${name}</div>
            <div class="match-team-scores">${sA.map((v,i)=>v>0||sB[i]>0?`<span${v>sB[i]?' class="winning-score"':''}>${v}</span>`:'').join('')}</div></div>`;

          card.innerHTML+=`<div class="match-container">
            ${row(1,teamA,scoresA,scoresB)}
            ${row(2,teamB,scoresB,scoresA)}
            ${unplayed?'<div class="match-unplayed">Match Ã  jouer</div>':''}
          </div>`;
        });
        cont.appendChild(card);
      }
    }

    // --- TABLEAU FINAL ---
    function remplirTableauFinal(data){
      const tbody=document.querySelector('#tableauFinal tbody');
      tbody.innerHTML=data.filter(r=>Object.values(r).some(Boolean)).map(r=>{
        const cols=["Phase","Match","Ã‰quipe A","Ã‰quipe B","Score A","Score B","Vainqueur"];
        return `<tr>${cols.map(c=>{
          const v=r[c]||r[c.replace('Ã‰','E')]||"";
          return `<td${c==="Vainqueur"&&v?' class="winner"':''}>${v}</td>`;
        }).join('')}</tr>`;
      }).join('');
    }

    // --- MODAL ---
    const modal=document.getElementById('playerModal');
    document.getElementById('modalClose').onclick=()=>modal.style.display='none';
    window.onclick=e=>e.target===modal&&(modal.style.display='none');

    // --- CHARGEMENT ---
    Papa.parse(urls.equipes,{download:true,header:true,complete:r=>afficherPoules(r.data)});
    Papa.parse(urls.matchs, {download:true,header:true,complete:r=>afficherMatchesPoules(r.data)});
    Papa.parse(urls.tableau,{download:true,header:true,complete:r=>remplirTableauFinal(r.data)});
  </script>
</body>
</html>
